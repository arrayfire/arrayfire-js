{"version":3,"sources":["../es6/ArrayFire.js"],"names":["os","require","_","fastcall","Promise","Library","device","errors","enums","unified","AFArray","assert","typedefs","Dim4","Seq","Col","Cols","Row","Rows","ref","defOptions","async","chainable","span","Symbol","created","dtypeMap","ArrayFire","options","Error","Object","freeze","defaults","_lib","getLibName","_makeLibOptions","_batch","define","release","Reflect","construct","arguments","values","value","isObject","keys","key","curr","TypeError","array","Int8Array","dtype","u8","Uint8Array","Uint8ClampedArray","Int16Array","s16","Uint16Array","u16","Int32Array","s32","Uint32Array","u32","Float32Array","f32","Float64Array","f64","type","types","float","c32","double","c64","b8","bool","uint32","uint8","s64","int64","u64","uint64","int16","uint16","init","call","done","undefined","noop","Caller","prototype","_asChainable","process","apply","then","verify","result","caller","callMode","sync","syncMode","lock","scope","backend","source","func","errs","map","arg","idx","resolve","catch","push","err","length","ArrayFireChainedError","args","module","exports","plat","platform","isWin","isOSX","postfix","prefix"],"mappings":"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","file":"ArrayFire.js","sourcesContent":["'use strict';\nconst os = require('os');\nconst _ = require('lodash');\nconst fastcall = require('fastcall');\nconst Promise = require('bluebird');\nconst Library = fastcall.Library;\nconst device = require('./device');\nconst errors = require('./errors');\nconst enums = require('./enums');\nconst unified = require('./unified');\nconst AFArray = require('./AFArray');\nconst assert = require('assert');\nconst typedefs = require('./typedefs');\nconst Dim4 = require('./Dim4');\nconst Seq = require('./Seq');\nconst Col = require('./Col');\nconst Cols = require('./Cols');\nconst Row = require('./Row');\nconst Rows = require('./Rows');\nconst ref = fastcall.ref;\n\nconst defOptions = {\n    async: false,\n    chainable: true\n};\n\nconst span = Symbol('span');\n\nlet created = false;\n\nlet dtypeMap = null;\n\nclass ArrayFire {\n    constructor(options) {\n        if (created) {\n            throw new Error('Only one instance of ArrayFire class allowed.');\n        }\n\n        this.options = Object.freeze(_.defaults(options, defOptions));\n        this._lib = new Library(getLibName(), this._makeLibOptions());\n        this._batch = false;\n\n        typedefs.define(this);\n        Dim4.define(this);\n        Seq.define(this);\n        Col.define(this);\n        Cols.define(this);\n        Row.define(this);\n        Rows.define(this);\n        device(this);\n        unified(this);\n        AFArray.define(this);\n\n        created = true;\n    }\n\n    release() {\n        this._lib.release();\n        created = false;\n    }\n\n    get scope() {\n        return fastcall.scope;\n    }\n\n    get span() {\n        return span;\n    }\n\n    dim4() {\n        return Reflect.construct(Dim4, arguments);\n    }\n\n    get backend() {\n        return enums.backend;\n    }\n\n    get dtype() {\n        return enums.dtype;\n    }\n\n    get source() {\n        return enums.source;\n    }\n\n    enumToString(values, value) {\n        assert(_.isObject(values), 'Argument \"values\" is not an object.');\n\n        for (const key of _.keys(values)) {\n            const curr = values[key];\n            if (curr === value) {\n                return key;\n            }\n        }\n\n        throw new TypeError(`Value \"${ value }\" not fuond on enum values.`);\n    }\n\n    getDTypeOfTypedArray(array) {\n        if (array instanceof Int8Array) {\n            return enums.dtype.u8;\n        }\n        if (array instanceof Uint8Array) {\n            return enums.dtype.u8;\n        }\n        if (array instanceof Uint8ClampedArray) {\n            return enums.dtype.u8;\n        }\n        if (array instanceof Int16Array) {\n            return enums.dtype.s16;\n        }\n        if (array instanceof Uint16Array) {\n            return enums.dtype.u16;\n        }\n        if (array instanceof Int32Array) {\n            return enums.dtype.s32;\n        }\n        if (array instanceof Uint32Array) {\n            return enums.dtype.u32;\n        }\n        if (array instanceof Float32Array) {\n            return enums.dtype.f32;\n        }\n        if (array instanceof Float64Array) {\n            return enums.dtype.f64;\n        }\n        throw new TypeError('Argument \"array\" is not a typed array.');\n    }\n\n    dtypeToRefType(type) {\n        switch (type) {\n            case enums.dtype.f32:\n                return ref.types.float;\n            case enums.dtype.c32:\n                throw new Error('Complext types are not supported yet.');\n            case enums.dtype.f64:\n                return ref.types.double;\n            case enums.dtype.c64:\n                throw new Error('Complext types are not supported yet.');\n            case enums.dtype.b8:\n                return ref.types.bool;\n            case enums.dtype.s32:\n                return ref.types.uint32;\n            case enums.dtype.u32:\n                return ref.types.uint32;\n            case enums.dtype.u8:\n                return ref.types.uint8;\n            case enums.dtype.s64:\n                return ref.types.int64;\n            case enums.dtype.u64:\n                return ref.types.uint64;\n            case enums.dtype.s16:\n                return ref.types.int16;\n            case enums.dtype.u16:\n                return ref.types.uint16;\n            default:\n                throw new TypeError(`Argument value \"${ type }\" is not a valid dtype.`);\n        }\n    }\n\n    _makeFunction(init, call, done) {\n        if (done === undefined) {\n            done = call;\n            call = init;\n            init = _.noop;\n        }\n\n        const Caller = function () {\n            init.call(this);\n        };\n\n        Caller.prototype.call = call;\n\n        Caller.prototype.done = done || _.noop;\n\n        if (this.options.async) {\n            if (this.options.chainable) {\n                Caller.prototype.call = ArrayFire._asChainable(call);\n            }\n            Caller.prototype.process = function () {\n                return this.call.apply(this, arguments)\n                .then(result => {\n                    errors.verify(result);\n                    return this.done(result);\n                });\n            };\n            return function () {\n                const caller = new Caller();\n                return caller.process.apply(caller, arguments);\n            };\n        }\n        else {\n            Caller.prototype.process = function () {\n                const result = this.call.apply(this, arguments);\n                errors.verify(result);\n                return this.done(result);\n            };\n            const caller = new Caller();\n            return function () {\n                return caller.process.apply(caller, arguments);\n            };\n        }\n    }\n\n    static _asChainable(func) {\n        return function () {\n            const errs = [];\n            return Promise.map(arguments, (arg, idx) => {\n                return Promise.resolve(arg)\n                .catch(err => {\n                    errs.push(err);\n                    return null;\n                });\n            })\n            .then(args => {\n                if (errs.length) {\n                    throw new errors.ArrayFireChainedError(errs);\n                }\n                return func.apply(this, args);\n            });\n        };\n    }\n\n    _makeLibOptions() {\n        return {\n            callMode: this.options.async ? Library.callMode.async : Library.callMode.sync,\n            syncMode: Library.syncMode.lock // TODO: benchmark for this\n        };\n    }\n}\n\nmodule.exports = ArrayFire;\n\nfunction getLibName() {\n    const plat = os.platform();\n    const isWin = plat === 'win32';\n    const isOSX = plat === 'darwin';\n    let postfix = '';\n    let prefix = '';\n    if (isOSX) {\n        postfix = '.dynlib';\n    }\n    else if (!isWin) {\n        postfix = '.so';\n    }\n    if (!isWin) {\n        prefix = 'lib';\n    }\n    return prefix + 'af' + postfix;\n}"]}