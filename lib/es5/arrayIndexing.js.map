{"version":3,"sources":["../es6/arrayIndexing.js"],"names":["fastcall","require","ref","typedefs","handleType","helpers","Promise","async","coroutine","Seq","assert","Idx","module","exports","af","AFArray","lib","_lib","intf","interface","callAssign","declare","index","_makeFunction","out","alloc","array","idx","asIdx","af_index_gen","getHandle","ndims","buffer","deref","assign","value","undefined","options","arrayHandle","scope","context","rhs","_","isNumber","constant","getDims","lhs","af_assign_gen","indices"],"mappings":"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","file":"arrayIndexing.js","sourcesContent":["'use strict';\nconst fastcall = require('fastcall');\nconst ref = fastcall.ref;\nconst typedefs = require('./typedefs');\nconst handleType = typedefs.handleType;\nconst helpers = require('./helpers');\nconst Promise = require('bluebird');\nconst async = Promise.coroutine;\nconst Seq = require('./Seq');\nconst assert = require('assert');\nconst Idx = require('./Idx');\n\nmodule.exports = function (af, AFArray) {\n    const lib = af._lib;\n    const intf = lib.interface;\n\n    let callAssign = null;\n\n    // .get\n\n    lib.declare('int af_index_gen(void** out, void* in, longlong ndims, IndexT* indices)');\n\n    af.index = af._makeFunction(\n        function () {\n            this.out = ref.alloc(handleType);\n        },\n        function (array, idx) {\n            idx = asIdx(idx);\n            return intf.af_index_gen(this.out, helpers.getHandle(array), idx.ndims, idx.buffer);\n        },\n        function () {\n            return this.out.deref();\n        });\n\n    // .set\n\n    lib.declare('int af_assign_gen(void** out, void* lhs, longlong ndims, IndexT* indices, void* rhs)');\n\n    af.assign = af._makeFunction(\n        function () {\n            this.out = ref.alloc(handleType);\n        },\n        function (array, idx, value) {\n            idx = asIdx(idx);\n            assert(value !== undefined, 'Argument \"value\" expected.');\n            return callAssign(this.out, helpers.getHandle(array), idx, value);\n        },\n        function () {\n            return this.out.deref();\n        });\n\n    function asIdx(idx) {\n        if (idx instanceof Idx) {\n            return idx;\n        }\n        return af.idx(idx);\n    }\n\n    if (af.options.async) {\n        callAssign = function (arrayHandle, idx, value) {\n            return af.scope.async(function* (context, rhs) {\n                if (_.isNumber(rhs)) {\n                    rhs = yield af.constant(af.getDims(context.lhs), rhs);\n                }\n                return intf.af_assign_gen(context.out, helpers.getHandle(context.lhs), context.ndims, context.indices, helpers.getHandle(rhs));\n            });\n        };\n    }\n    else {\n        callAssign = function (out, arrayHandle, idx, value) {\n            af.scope(() => {\n                let rhs;\n                if (_.isNumber(value)) {\n                    rhs = af.constant(af.getDims(arrayHandle), value);\n                }\n                else {\n                    rhs = helpers.getHandle(value);\n                }\n                return intf.af_assign_gen(out, arrayHandle, idx.ndims, idx.buffer, rhs);\n            });\n        };\n    }\n};"]}